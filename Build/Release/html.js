var Html=function(){if(arguments.length===0)this.languages=[];if(arguments.length===1)this.languages=arguments[0]};Html.prototype.begin=function(a,b){this.textReader=a;this.tokenStack=[{type:this.readText}];this.languageToken=null;if(b!==null){var d=b.split(":");if(d.length>1){var e=d[0],g=d[1],f=this.languages[e];if(f){f.begin(this.textReader,d[2]);this.push({type:this.readLanguage,mimeType:e,language:f,closeTag:g,contentData:0})}}}};
Html.prototype.read=function(){this.state=null;this.token=this.tokenStack[this.tokenStack.length-1];if(this.token.type===this.readLanguage)return this.token.type.apply(this);return{style:this.token.type.apply(this),state:this.state}};
Html.prototype.readText=function(){if(this.textReader.match("<")){if(this.tokenStack.length===1)this.state="base";if(this.textReader.match("!"))if(this.textReader.match("--")){this.push({type:this.readComment});return"comment"}else if(this.textReader.match("[CDATA[")){this.push({type:this.readConstantData});return"literal"}else{this.push({type:this.readDocType});return"punctuation"}else{if(this.textReader.match("?"))this.push({type:this.readProcessingInstruction});else this.textReader.match("/")?
this.push({type:this.readEndTag}):this.push({type:this.readStartTag,name:"",hasAttributes:false});return"punctuation"}}else if(this.textReader.match("&")){this.push({type:this.readEntity});return"literal"}this.textReader.read();return"text"};
Html.prototype.readStartTag=function(){if(this.textReader.skipWhitespaces()){this.token.hasAttributes=true;this.push({type:this.readAttribute,name:"",hasValue:false});return"text"}if(this.textReader.match(">")||this.textReader.match("/>")){this.pop();this.setLanguage();return"punctuation"}c=this.textReader.read();this.token.hasAttributes||(this.token.name+=c);return"element"};
Html.prototype.readEndTag=function(){if(this.textReader.match(">")){this.pop();return"punctuation"}this.token.name+=this.textReader.read();return"element"};
Html.prototype.readAttribute=function(){if(this.textReader.skipWhitespaces())return"text";else if(this.textReader.match(">")){this.pop();this.pop();this.setLanguage();return"punctuation"}else if(this.textReader.match("=")){this.push({type:this.readAttributeValue,value:"",quote:""});this.token.hasValue=true;return"punctuation"}c=this.textReader.peek();if(c==="/"){this.pop();return"punctuation"}this.textReader.read();this.token.hasValue||(this.token.name+=c);return"attribute"};
Html.prototype.readAttributeValue=function(){c=this.textReader.peek();if(this.token.quote==="")if(c==="'"){this.textReader.read();this.token.quote="s";return"literal"}else if(c==='"'){this.textReader.read();this.token.quote="d";return"literal"}else if(this.textReader.skipWhitespaces())return"text";else this.token.quote="-";var a=false,b="";if(this.token.quote==="s"&&c==="'"){this.textReader.read();this.pop();b="literal"}else if(this.token.quote==="d"&&c==='"'){this.textReader.read();this.pop();b=
"literal"}else if(this.token.quote==="-"&&this.textReader.skipWhitespaces()){this.pop();b="text"}else if(this.token.quote==="-"&&c===">"){this.textReader.read();this.pop();a=true;b="punctuation"}if(b.length===0){this.token.value+=this.textReader.read();return"literal"}attributeName=this.tokenStack[this.tokenStack.length-1].name.toUpperCase();elementName=this.tokenStack[this.tokenStack.length-2].name.toUpperCase();if(attributeName==="TYPE"&&elementName==="SCRIPT"||attributeName==="TYPE"&&elementName===
"STYLE"){var d=this.token.value,e=this.languages[d];if(e){e.begin(this.textReader,null);this.languageToken={type:this.readLanguage,mimeType:d,language:e,closeTag:"</"+elementName+">",contentData:0}}}this.pop();if(a){this.pop();this.setLanguage()}else this.push({type:this.readAttribute,name:"",value:false});return b};Html.prototype.readComment=function(){this.terminate("--\>");return"comment"};Html.prototype.readConstantData=function(){this.terminate("]]\>");return"literal"};
Html.prototype.readEntity=function(){c=this.textReader.read();if(c==="\n"||c===";")this.pop();return"literal"};Html.prototype.readDocType=function(){return this.terminate(">")?"punctuation":"element"};Html.prototype.readProcessingInstruction=function(){return this.terminate("?>")?"punctuation":"literal"};
Html.prototype.readLanguage=function(){c=this.textReader.peek();if(c==="<"||c==="]"){if(this.testIgnoreCase("<![CDATA["))this.token.contentData++;else this.testIgnoreCase("]]\>")&&this.token.contentData>0&&this.token.contentData--;if(this.token.contentData==0&&this.testIgnoreCase(this.token.closeTag)){this.pop();return this.read()}}var a=this.token.language.read();a.state=a.state!==null?this.token.mimeType+":"+this.token.closeTag+":"+a.state:null;return a};Html.prototype.push=function(a){this.tokenStack.push(a)};
Html.prototype.pop=function(){this.tokenStack.pop()};Html.prototype.setLanguage=function(){if(this.languageToken!==null){this.push(this.languageToken);this.languageToken=null}};Html.prototype.terminate=function(a){if(this.textReader.match(a)){this.pop();return true}this.textReader.read();return false};
Html.prototype.testIgnoreCase=function(a){this.textReader.save();for(var b=0;b<a.length;b++){c=this.textReader.read();if(c===-1||c.toUpperCase()!==a[b].toUpperCase()){this.textReader.restore();return false}}this.textReader.restore();return true};
